# MCPチャット統合 - テストレポート

**Issue**: BlazorWeb（UI/チャット）：MCPサーバー連携・動作検証  
**実装者**: GitHub Copilot  
**テスト日**: 2024-11-24  
**ステータス**: 実装完了 - 手動テスト推奨

## 実装内容サマリー

### 実装済み機能

1. **MCPクライアントサービス** (`McpChatService`)
   - 複数MCPサーバーの同時管理
   - 接続プーリング
   - ツール検索とキャッシング
   - タイムアウト管理（接続: 5秒、実行: 30秒）
   - OpenTelemetry統合

2. **MudBlazor UIコンポーネント** (`McpChat.razor`)
   - サーバー接続UI
   - ツール選択と実行UI
   - チャット履歴表示
   - インラインヘルプガイド
   - レスポンシブデザイン

3. **設定とインフラ**
   - 4つのMCPサーバー設定（appsettings.json）
   - DIコンテナ統合
   - ナビゲーションメニュー追加

4. **ドキュメント**
   - ユーザーガイド完成

## テストシナリオ

### 1. 基本接続テスト

#### 1.1 全サービス接続

**手順**:
1. MCPチャット画面にアクセス
2. 「全サービスに接続」ボタンをクリック
3. 接続結果を確認

**期待結果**:
- ✅ 4つのサービスすべてに接続成功
- ✅ 接続状態パネルに4サービス表示
- ✅ 各サービスのツール数が表示される
- ✅ チャット履歴に接続成功メッセージ

**テスト環境要件**:
- Aspire AppHost起動済み
- 全マイクロサービス（EmployeeService, AuthService, NotificationService, AttendanceService）が稼働中
- 各サービスの `/api/mcp` エンドポイントがアクセス可能

**潜在的な問題**:
- ⚠️ CI/CD環境ではAspire起動に問題がある可能性
- ⚠️ サービス起動順序によってはタイムアウトの可能性

#### 1.2 個別サーバー選択

**手順**:
1. 接続後、「従業員サービス」をクリック
2. ツールリストが表示されることを確認
3. 他のサービスも同様にテスト

**期待結果**:
- ✅ 選択したサービスのツールが右側に表示
- ✅ ツール数とサービス名が正しく表示

### 2. ツール実行テスト

#### 2.1 引数不要のツール実行（ListEmployeesAsync）

**手順**:
1. 従業員サービスを選択
2. 「ListEmployeesAsync」ツールを選択
3. 引数欄に `{}` を入力
4. 「ツールを実行」ボタンをクリック

**期待結果**:
- ✅ チャット履歴にユーザーメッセージ追加
- ✅ 実行中スピナー表示
- ✅ 従業員一覧のJSON結果が表示
- ✅ ✅マーク付き成功メッセージ

**検証ポイント**:
- JSON整形が適切に行われているか
- タイムスタンプが正しく表示されているか

#### 2.2 引数必須のツール実行（GetEmployeeAsync）

**前提条件**: 有効な従業員IDを事前に取得

**手順**:
1. 従業員サービスを選択
2. 「GetEmployeeAsync」ツールを選択
3. 引数欄に以下を入力:
   ```json
   {
     "employeeId": "実際のGUID"
   }
   ```
4. 「ツールを実行」ボタンをクリック

**期待結果**:
- ✅ 指定した従業員の詳細情報がJSON形式で表示
- ✅ 名前、メール、部署などの情報が含まれる

#### 2.3 エラーハンドリングテスト

**手順**:
1. 従業員サービスを選択
2. 「GetEmployeeAsync」ツールを選択
3. 不正なGUIDを入力:
   ```json
   {
     "employeeId": "invalid-guid"
   }
   ```
4. 「ツールを実行」ボタンをクリック

**期待結果**:
- ✅ エラーメッセージがチャット履歴に表示
- ✅ ❌マーク付きエラー表示
- ✅ ツール実行パネルにもエラー表示

### 3. UIインタラクションテスト

#### 3.1 ツールリスト更新

**手順**:
1. 接続状態パネルの🔄ボタンをクリック
2. システムメッセージを確認

**期待結果**:
- ✅ 「ツールリストを更新しました」メッセージ
- ✅ ツール数が再取得される

#### 3.2 チャット履歴クリア

**手順**:
1. いくつかのツールを実行して履歴を作成
2. チャット履歴パネルの🗑️ボタンをクリック

**期待結果**:
- ✅ 全チャット履歴が削除される
- ✅ 「ツールを選択して実行してください」メッセージが表示

#### 3.3 全切断

**手順**:
1. 接続状態パネルの🔗ボタンをクリック
2. 初期画面に戻ることを確認

**期待結果**:
- ✅ 接続画面に戻る
- ✅ チャット履歴がクリアされる

### 4. 複数サービス連携テスト

#### 4.1 従業員サービス → 認証サービス

**シナリオ**: 従業員を作成後、そのユーザーのロールを確認

**手順**:
1. 従業員サービスで新規従業員を作成（CreateEmployeeAsync）
2. 認証サービスに切り替え
3. ユーザー一覧を取得（ListUsersAsync）
4. 作成した従業員のユーザー情報を確認

**期待結果**:
- ✅ サービス間でシームレスに切り替え可能
- ✅ 各サービスの状態が独立して管理される

### 5. パフォーマンステスト

#### 5.1 接続タイムアウト

**手順**:
1. サービスを停止した状態で接続を試みる

**期待結果**:
- ✅ 5秒以内にタイムアウト
- ✅ エラーメッセージが適切に表示
- ⚠️ 他のサービスへの接続は継続

#### 5.2 ツール実行タイムアウト

**手順**:
1. 長時間実行されるツールをシミュレート（または大量データ取得）

**期待結果**:
- ✅ 30秒でタイムアウト
- ✅ タイムアウトエラーメッセージ表示

### 6. OpenTelemetry統合テスト

#### 6.1 トレース確認

**手順**:
1. Aspireダッシュボードを開く
2. MCPチャットで複数のツールを実行
3. トレースビューでアクティビティを確認

**期待結果**:
- ✅ `BlazorWeb.McpChat` アクティビティソースが記録
- ✅ ConnectToServer, CallTool, RefreshTools アクティビティが表示
- ✅ サーバー名、ツール名がタグとして記録

#### 6.2 ログ確認

**手順**:
1. Aspireダッシュボードのログビューを開く
2. MCPチャットで操作を実行
3. BlazorWebのログを確認

**期待結果**:
- ✅ 接続、ツール実行のログが記録
- ✅ エラー時は適切なログレベル（Error/Warning）

## 既知の制限事項

### 1. 環境依存

- **Aspire環境**: CI/CD環境でのAspire起動が不安定
- **回避策**: ローカル開発環境でのテストを推奨

### 2. UI/UX

- **長いJSON結果**: 非常に大きなJSONは表示が読みづらい可能性
- **改善案**: JSON結果のフォーマッター、折りたたみ機能の追加

### 3. セキュリティ

- **認証**: 現在はMCP接続に認証が実装されていない
- **改善案**: JWT トークンを使用したMCP認証の追加

### 4. エラー処理

- **部分的な接続失敗**: 一部のサービスが接続失敗しても続行
- **現状**: 警告メッセージで通知
- **改善案**: 再接続機能の追加

## テスト環境セットアップ

### 前提条件

```bash
# .NET 10 SDK
dotnet --version  # 10.0以上

# パッケージ復元
cd /path/to/DotnetEmployeeManagementSystem
dotnet restore
```

### 起動手順

```bash
# 1. Aspire AppHost起動
dotnet run --project src/AppHost

# 2. ブラウザで以下にアクセス（Aspireダッシュボード表示）
# http://localhost:15XXX （ポートは起動時に表示）

# 3. ダッシュボードでBlazorWebのURLを確認してアクセス

# 4. MCPチャットに移動
# ナビゲーション > MCPチャット
```

### データベース初期化

```bash
# 初回実行時またはデータリセットが必要な場合
cd src/Services/EmployeeService/API
dotnet ef database update --project ../Infrastructure

cd ../../AuthService/API
dotnet ef database update --project ../Infrastructure

cd ../../AttendanceService/API
dotnet ef database update --project ../Infrastructure
```

## 推奨テスト順序

1. **基本接続テスト** (1.1, 1.2)
2. **引数不要ツール実行** (2.1)
3. **チャット履歴確認** - 結果が正しく表示されるか
4. **引数必須ツール実行** (2.2)
5. **エラーハンドリング** (2.3)
6. **UIインタラクション** (3.1, 3.2, 3.3)
7. **複数サービス連携** (4.1)
8. **OpenTelemetry確認** (6.1, 6.2)

## 成功基準

以下がすべて満たされれば実装成功:

- ✅ 4つのMCPサーバーに接続可能
- ✅ 各サービスのツールが正しく表示
- ✅ ツール実行とJSON結果表示が正常動作
- ✅ エラー時の適切なメッセージ表示
- ✅ チャット履歴の管理が正常動作
- ✅ UIがレスポンシブで使いやすい
- ✅ OpenTelemetryトレースが記録される

## 次のステップ

### 実装推奨項目

1. **リアルタイム通知統合**
   - SignalR経由でNotificationServiceのイベントを受信
   - チャット画面にリアルタイム通知表示

2. **認証機能**
   - MCP接続時にJWTトークンを使用
   - ユーザー権限に応じたツール制限

3. **UI改善**
   - JSON結果のシンタックスハイライト
   - ツール検索機能
   - お気に入りツール登録

4. **履歴機能**
   - 実行履歴のローカルストレージ保存
   - 過去の引数の再利用

5. **テスト自動化**
   - PlaywrightまたはSeleniumを使用したE2Eテスト
   - 統合テストの追加

## 備考

- このテストレポートは実装ガイドラインです
- 実際のテスト実行時は結果を記録してください
- 問題発見時は本ファイルに追記し、Issueを作成してください

---

**作成日**: 2024-11-24  
**レビュアー**: （テスト実行者が記入）  
**承認日**: （承認者が記入）
