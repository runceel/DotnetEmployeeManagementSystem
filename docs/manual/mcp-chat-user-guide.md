# MCPチャット - ユーザーガイド

## 概要

MCPチャット機能は、従業員管理システムの全サービス（従業員、認証、通知、勤怠）を統合的に操作できる対話型インターフェースです。Model Context Protocol (MCP)を通じて、各マイクロサービスの機能にアクセスし、JSONベースの引数で柔軟な操作が可能です。

## アクセス方法

1. ブラウザで従業員管理システムにアクセス
2. 左側のナビゲーションメニューから「MCPチャット」をクリック
3. MCPチャット画面が表示されます

## 画面構成

### 初期画面（未接続時）

初めてアクセスすると、サーバー接続パネルが表示されます：

- **サービスカード**: 4つの利用可能なサービスが表示されます
  - 従業員サービス（従業員と部署の管理）
  - 認証サービス（ユーザーとロールの管理）
  - 通知サービス（システム通知の管理）
  - 勤怠サービス（勤怠記録と休暇申請の管理）

- **接続ボタン**: 「全サービスに接続」ボタンをクリックして一括接続

### メイン画面（接続後）

接続が成功すると、3つのパネルが表示されます：

#### 1. 左側パネル - サーバー管理

**接続状態セクション**
- 接続済みサービスの一覧
- 各サービスの利用可能なツール数
- ツールリスト更新ボタン（🔄）
- 全切断ボタン（🔗）

**利用可能なツールセクション**
- サーバーを選択すると、そのサービスのツール一覧が表示
- 各ツールには名前と説明が表示
- ツールをクリックして選択

#### 2. 右上パネル - チャット履歴

- ユーザーの操作（青色の吹き出し）
- システムの応答（グレーの吹き出し）
- タイムスタンプ付き
- 履歴クリアボタン（🗑️）

#### 3. 右下パネル - ツール実行

- 選択したツールの情報
- JSON形式の引数入力欄
- 実行ボタン
- エラーメッセージ表示エリア

#### 4. ヘルプセクション（展開可能）

使い方ガイドとJSON引数の例が記載されています。

## 使い方

### 基本的な操作フロー

1. **サーバー選択**
   - 左側パネルの「接続状態」から操作したいサービスをクリック
   - 例: 従業員を管理する場合は「従業員サービス」を選択

2. **ツール選択**
   - 「利用可能なツール」リストから実行したい操作を選択
   - 例: 従業員一覧を取得する場合は「ListEmployeesAsync」を選択

3. **引数入力**
   - 右下パネルのテキストエリアにJSON形式で引数を入力
   - 引数が不要な場合は `{}` のまま
   - 例: 従業員一覧取得は引数不要なので `{}` のまま

4. **実行**
   - 「ツールを実行」ボタンをクリック
   - 実行中はスピナーが表示されます

5. **結果確認**
   - チャット履歴に実行結果が表示されます
   - 成功時は✅マークとJSON形式の結果
   - エラー時は❌マークとエラーメッセージ

## ツール別使用例

### 従業員サービス

#### 従業員一覧の取得

**ツール**: `ListEmployeesAsync`

**引数**:
```json
{}
```

**用途**: 全従業員の一覧を取得します。

#### 特定の従業員情報を取得

**ツール**: `GetEmployeeAsync`

**引数**:
```json
{
  "employeeId": "従業員のGUID"
}
```

**用途**: 指定した従業員IDの詳細情報を取得します。

#### メールアドレスで従業員を検索

**ツール**: `SearchEmployeeByEmailAsync`

**引数**:
```json
{
  "email": "taro.yamada@example.com"
}
```

**用途**: メールアドレスで従業員を検索します。

#### 従業員の新規登録

**ツール**: `CreateEmployeeAsync`

**引数**:
```json
{
  "firstName": "太郎",
  "lastName": "山田",
  "email": "taro.yamada@example.com",
  "departmentId": "部署のGUID",
  "position": "エンジニア",
  "hireDate": "2024-01-01"
}
```

**用途**: 新しい従業員を登録します。

#### 従業員情報の更新

**ツール**: `UpdateEmployeeAsync`

**引数**:
```json
{
  "employeeId": "従業員のGUID",
  "firstName": "太郎",
  "lastName": "山田",
  "email": "taro.yamada@example.com",
  "departmentId": "部署のGUID",
  "position": "シニアエンジニア",
  "hireDate": "2024-01-01"
}
```

**用途**: 既存の従業員情報を更新します（全項目必須）。

#### 従業員の削除

**ツール**: `DeleteEmployeeAsync`

**引数**:
```json
{
  "employeeId": "従業員のGUID"
}
```

**用途**: 従業員を削除します（この操作は取り消せません）。

### 部署管理

#### 部署一覧の取得

**ツール**: `ListDepartmentsAsync`

**引数**:
```json
{}
```

**用途**: 全部署の一覧を取得します。

#### 特定の部署情報を取得

**ツール**: `GetDepartmentAsync`

**引数**:
```json
{
  "departmentId": "部署のGUID"
}
```

**用途**: 指定した部署IDの詳細情報を取得します。

#### 部署の新規作成

**ツール**: `CreateDepartmentAsync`

**引数**:
```json
{
  "name": "開発部",
  "code": "DEV",
  "description": "システム開発を担当する部署"
}
```

**用途**: 新しい部署を作成します。

### 認証サービス

#### ユーザー一覧の取得

**ツール**: `ListUsersAsync`

**引数**:
```json
{}
```

**用途**: 全ユーザーの一覧を取得します。

#### ロール一覧の取得

**ツール**: `ListRolesAsync`

**引数**:
```json
{}
```

**用途**: システムに登録されているロール（役割）の一覧を取得します。

### 通知サービス

#### 通知一覧の取得

**ツール**: `ListNotificationsAsync`

**引数**:
```json
{
  "userId": "ユーザーのGUID"
}
```

**用途**: 特定ユーザーの通知一覧を取得します。

#### 通知の既読化

**ツール**: `MarkAsReadAsync`

**引数**:
```json
{
  "notificationId": "通知のGUID"
}
```

**用途**: 通知を既読にします。

### 勤怠サービス

#### 勤怠記録一覧の取得

**ツール**: `ListAttendanceRecordsAsync`

**引数**:
```json
{
  "employeeId": "従業員のGUID",
  "startDate": "2024-01-01",
  "endDate": "2024-01-31"
}
```

**用途**: 指定した期間の勤怠記録を取得します。

#### 出勤記録の登録

**ツール**: `CheckInAsync`

**引数**:
```json
{
  "employeeId": "従業員のGUID",
  "timestamp": "2024-01-15T09:00:00"
}
```

**用途**: 出勤時刻を記録します。

#### 退勤記録の登録

**ツール**: `CheckOutAsync`

**引数**:
```json
{
  "employeeId": "従業員のGUID",
  "timestamp": "2024-01-15T18:00:00"
}
```

**用途**: 退勤時刻を記録します。

## よくあるエラーと対処法

### 接続エラー

**エラー**: 「一部のサーバーに接続できませんでした」

**原因**:
- サービスが起動していない
- ネットワーク接続の問題
- サービスのMCPエンドポイントが無効

**対処法**:
1. Aspire ダッシュボードで全サービスが起動していることを確認
2. 各サービスの `/api/mcp` エンドポイントにアクセスできるか確認
3. ツールリスト更新ボタンをクリックして再接続を試みる

### JSON形式エラー

**エラー**: 「JSON形式が正しくありません」

**原因**:
- JSON構文エラー
- ダブルクォーテーションの欠落
- カンマの位置ミス

**対処法**:
1. JSONバリデーターで構文をチェック
2. ヘルプセクションの例を参考に修正
3. オブジェクト: `{}`、文字列: `"value"`、数値: `123`、配列: `[]`

### ツール実行エラー

**エラー**: 「実行エラー: Invalid employee ID format」

**原因**:
- 引数の型が正しくない
- 必須パラメータが欠落
- GUIDフォーマットが不正

**対処法**:
1. ツールの説明を再確認
2. パラメータ名のスペルミスをチェック
3. GUID形式: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
4. 日付形式: ISO 8601 (`2024-01-01`)

### タイムアウトエラー

**エラー**: 「実行エラー: The operation didn't complete within the allowed timeout」

**原因**:
- サービスの処理が30秒以内に完了しなかった
- データベースのパフォーマンス問題
- サービスの負荷が高い

**対処法**:
1. しばらく時間をおいてから再試行
2. システム管理者に連絡してサービスの状態を確認
3. Aspire ダッシュボードでサービスのログを確認

## Tips & ベストプラクティス

### 効率的な操作

1. **事前準備**
   - よく使う引数のJSONをテキストファイルに保存
   - GUIDなどの識別子を事前にメモ

2. **エラー防止**
   - 削除操作の前に必ず確認
   - 本番データでの試行前にテスト環境で確認

3. **チャット履歴の活用**
   - 過去の成功した操作を参照
   - エラーメッセージをコピーして調査

### セキュリティ

- MCPチャットは強力な操作権限を持ちます
- 本番環境では適切なアクセス制御を設定
- 削除操作は慎重に実行
- 機密情報を含む引数はチャット履歴に残るため注意

### パフォーマンス

- 大量データの取得時は日付範囲を絞る
- 一度に多数のツールを実行しない
- 定期的にチャット履歴をクリア

## トラブルシューティング

### 一般的な問題

| 問題 | 解決策 |
|------|--------|
| ツールが表示されない | サーバー選択を確認、ツールリスト更新を試行 |
| 実行ボタンが押せない | ツールが選択されているか確認 |
| チャット履歴が表示されない | ブラウザをリフレッシュ |
| 結果が見づらい | JSONフォーマッターツールを使用 |

### サポート

問題が解決しない場合:

1. Aspire ダッシュボードでログを確認
2. ブラウザのデベロッパーツール（F12）でコンソールエラーをチェック
3. システム管理者に連絡

## 関連ドキュメント

- [MCP統合設計書](../mcp-integration-design.md)
- [MCP実装ガイド](../mcp-implementation-guide.md)
- [従業員サービス MCP API リファレンス](../employee-service-mcp-api-reference.md)
- [認証サービス MCP API リファレンス](../auth-service-mcp-api-reference.md)
- [勤怠サービス MCP API リファレンス](../attendance-service-mcp-api-reference.md)

---

**最終更新日**: 2024-11-24  
**バージョン**: 1.0  
**対象**: BlazorWeb MCPチャット機能
