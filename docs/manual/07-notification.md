# 第7章: 通知管理

## 📋 目次

1. [概要](#概要)
2. [通知管理画面へのアクセス](#通知管理画面へのアクセス)
3. [通知履歴の確認](#通知履歴の確認)
4. [テスト通知の送信](#テスト通知の送信)
5. [通知状態の確認方法](#通知状態の確認方法)
6. [自動通知について](#自動通知について)
7. [よくある質問](#よくある質問)

## 概要

通知管理機能は、従業員に対するメール通知を管理するための機能です。システムは従業員の登録・更新・削除時に自動的に通知を送信し、管理者は手動でテスト通知を送信することもできます。

### 主な機能

✅ **通知履歴の閲覧**: 送信済み・送信待ち・失敗した通知の履歴を確認
✅ **テスト通知の送信**: 管理者が任意の従業員にテスト通知を送信
✅ **自動通知**: 従業員の作成・更新・削除時に自動的に通知を送信
✅ **通知状態の追跡**: 各通知の状態（送信待ち・送信済み・失敗）をリアルタイムで確認

## 通知管理画面へのアクセス

### 1. メインメニューから選択

1. BlazorWebアプリにアクセス
2. 左側のナビゲーションメニューから「**通知管理**」をクリック

![通知管理メニュー](../images/notification-menu.png)

### 2. 画面構成

通知管理画面は2つのタブで構成されています：

- **通知履歴**: すべての通知の送信履歴を確認
- **テスト通知送信**: 従業員に手動でテスト通知を送信

## 通知履歴の確認

### 通知履歴タブ

通知履歴タブでは、システムが送信した（または送信予定の）すべての通知を確認できます。

#### 表示される情報

| 項目 | 説明 |
|------|------|
| **作成日時** | 通知が作成された日時 |
| **受信者** | 通知の受信者名とメールアドレス |
| **通知タイプ** | 通知の種類（従業員作成・更新・削除・手動送信） |
| **件名** | メールの件名 |
| **状態** | 通知の現在の状態（送信待ち・送信済み・失敗） |
| **送信日時** | 実際に送信された日時（送信済みの場合のみ） |

#### 通知履歴の更新

通知履歴を最新の状態に更新するには：

1. 「**更新**」ボタンをクリック
2. システムが最新の通知情報を取得し、表示を更新します

### 通知タイプの見方

通知には以下の4つのタイプがあります：

| タイプ | 色 | 説明 |
|--------|-----|------|
| **従業員作成** | 緑 | 新しい従業員が登録されたときの「ようこそメール」 |
| **従業員更新** | 青 | 従業員情報が更新されたときの通知 |
| **従業員削除** | オレンジ | 従業員が削除されたときの通知 |
| **手動送信** | 紫 | 管理者が手動で送信したテスト通知 |

### 通知状態の色分け

通知の状態は色分けされており、一目で確認できます：

| 状態 | 色 | 説明 |
|------|-----|------|
| **送信待ち** | オレンジ | まだ送信されていない通知（数秒～数十秒で送信されます） |
| **送信済み** | 緑 | 正常に送信完了した通知 |
| **失敗** | 赤 | 送信に失敗した通知（エラーメッセージを確認してください） |

## テスト通知の送信

管理者は「テスト通知送信」タブから、任意の従業員にテスト通知を送信できます。

### 送信手順

1. **「テスト通知送信」タブ**を選択
2. **従業員を選択**ドロップダウンから通知を送信する従業員を選択
3. **件名**を入力（例：「テスト通知」）
4. **メッセージ**を入力（複数行可）
5. **「通知を送信」ボタン**をクリック

### 送信後の確認

通知を送信すると：

1. 画面右上に「テスト通知を送信しました」というメッセージが表示されます
2. 自動的に通知履歴タブの内容が更新されます
3. 送信した通知が履歴に追加され、「送信待ち」状態になります
4. 数秒～数十秒後に「送信済み」状態に変わります

### デフォルトのテスト通知

テスト通知送信タブには、以下のデフォルト値が設定されています：

- **件名**: 「テスト通知」
- **メッセージ**: 「これはテスト通知のメッセージです。\n\nシステムから自動送信されました。」

これらは自由に変更できます。

## 通知状態の確認方法

### リアルタイムでの状態確認

通知の状態は以下の流れで変化します：

```
[作成] → [送信待ち] → [送信済み]
                   ↘ [失敗]
```

1. **作成時**: 通知が作成され、データベースに保存されます
2. **送信待ち**: 通知処理ワーカーが10秒ごとにチェックし、送信を試みます
3. **送信済み**: メール送信が成功すると、状態が「送信済み」に更新されます
4. **失敗**: 送信に失敗した場合は「失敗」状態になり、エラーメッセージが記録されます

### 送信待ち通知の処理時間

通知が「送信待ち」状態から「送信済み」状態になるまでの時間：

- **通常**: 10秒～20秒程度
- システムは10秒ごとに送信待ち通知をチェックしています
- 大量の通知がある場合は、若干時間がかかることがあります

### 失敗した通知の確認

通知が「失敗」状態になった場合：

1. 通知履歴で赤色のチップで表示されます
2. 管理者に連絡し、システムログを確認してもらってください
3. エラーの原因が解決されると、システムは自動的に再送信を試みます

## 自動通知について

システムは以下のイベント発生時に自動的に通知を作成・送信します。

### 従業員作成時の通知

新しい従業員が登録されると、「ようこそメール」が自動送信されます。

#### 送信内容の例

```
件名: ようこそ！従業員登録が完了しました

山田 太郎 様

従業員管理システムへようこそ！
あなたの従業員情報が正常に登録されました。

【登録情報】
- 氏名: 山田 太郎
- メールアドレス: yamada.taro@example.com
- 部署: 開発部
- 役職: エンジニア
- 登録日: 2025年11月10日 13:30

今後ともよろしくお願いいたします。

従業員管理システム
```

#### 確認方法

1. 従業員管理画面で新しい従業員を登録
2. 通知管理画面を開く
3. 通知履歴に「従業員作成」タイプの通知が追加されていることを確認
4. 数秒～数十秒後に「送信済み」状態になることを確認

### 従業員更新時の通知

従業員情報が更新されると、更新通知が自動送信されます。

#### 送信内容の例

```
件名: 従業員情報が更新されました

山田 太郎 様

あなたの従業員情報が更新されました。

【更新日時】
2025年11月10日 14:30

変更内容を確認してください。
ご不明な点がございましたら、人事部までお問い合わせください。

従業員管理システム
```

### 従業員削除時の通知

従業員が削除されると、削除通知が自動送信されます。

#### 送信内容の例

```
件名: 従業員情報が削除されました

山田 太郎 様

あなたの従業員情報がシステムから削除されました。

【削除日時】
2025年11月10日 15:30

これまでご利用いただきありがとうございました。

従業員管理システム
```

## よくある質問

### Q1: 通知が送信されない

**A**: 以下の点を確認してください：

1. **通知履歴で状態を確認**
   - 「送信待ち」の場合: 10～20秒待ってから更新ボタンをクリック
   - 「失敗」の場合: システム管理者に連絡してエラーログを確認してもらう

2. **メールアドレスが正しいか確認**
   - 従業員管理画面で受信者のメールアドレスを確認
   - 無効なメールアドレスの場合は送信に失敗します

3. **システムが正常に動作しているか確認**
   - Aspireダッシュボードで NotificationService の状態を確認
   - 管理者に連絡してサービスの再起動を依頼

### Q2: テスト通知を送信できない

**A**: 以下の点を確認してください：

1. **すべての必須項目が入力されているか**
   - 従業員が選択されている
   - 件名が入力されている
   - メッセージが入力されている

2. **従業員が登録されているか**
   - 「従業員が登録されていません」と表示される場合、先に従業員を登録してください

3. **送信中の状態のまま変わらない**
   - ページを再読み込みしてみる
   - 管理者に連絡してシステムログを確認してもらう

### Q3: 通知履歴が表示されない

**A**: 以下の手順を試してください：

1. **更新ボタンをクリック**
   - 通知履歴タブの「更新」ボタンをクリック

2. **ページを再読み込み**
   - ブラウザのリロードボタンをクリック（Ctrl+R / Cmd+R）

3. **まだ通知が作成されていない**
   - 「通知履歴がありません」と表示される場合、まだ通知が作成されていません
   - 従業員を作成するか、テスト通知を送信してみてください

### Q4: 通知が「失敗」状態になったら？

**A**: 以下の対応を行ってください：

1. **状態を確認**
   - 通知履歴で失敗した通知を確認

2. **管理者に連絡**
   - システム管理者にエラーの詳細を確認してもらう
   - 管理者はAspireダッシュボードやデータベースでエラーメッセージを確認できます

3. **一時的なエラーの場合**
   - システムは自動的に再送信を試みます
   - エラーが解決されると、次の処理サイクル（10秒後）で送信されます

4. **恒久的なエラーの場合**
   - メールアドレスが無効な場合は、従業員情報を修正
   - システムの設定エラーの場合は、管理者に修正を依頼

### Q5: 通知はいつ送信される？

**A**: 通知の送信タイミングは以下の通りです：

- **自動通知**: 従業員の作成・更新・削除の直後に通知が作成され、10秒以内に送信されます
- **手動通知**: テスト通知送信後、10秒以内に送信されます
- **処理サイクル**: システムは10秒ごとに送信待ち通知をチェックして送信します

### Q6: 送信済み通知を再送信できる？

**A**: 現在のバージョンでは、送信済み通知を再送信する機能はありません。
同じ内容を再度送信したい場合は、テスト通知送信機能を使用して新しい通知を作成してください。

### Q7: 通知履歴を削除できる？

**A**: 現在のバージョンでは、通知履歴を削除する機能はありません。
すべての通知は監査目的で保持されます。

### Q8: 開発環境でメールは実際に送信される？

**A**: いいえ。開発環境では実際のメール送信は行われません。
代わりに、メールの内容がコンソールログに出力されます。これにより、開発者はメールの内容を確認できます。

本番環境では、実際のメール送信サービス（SMTP等）が使用され、メールが実際に送信されます。

## まとめ

通知管理機能を使用することで：

✅ すべての通知の送信履歴を確認できます
✅ 管理者は任意の従業員にテスト通知を送信できます
✅ 従業員の作成・更新・削除時に自動的に通知が送信されます
✅ 各通知の状態をリアルタイムで追跡できます

通知機能により、従業員とのコミュニケーションが円滑になり、重要なイベントを確実に伝えることができます。

---

## 関連ドキュメント

- [通知サービス実装ガイド](../notification-service.md) - 技術的な実装詳細（開発者向け）
- [Aspireダッシュボード](../aspire-dashboard.md) - システム監視とデバッグ方法
- [Getting Started](../getting-started.md) - システムのセットアップと起動方法
- [アーキテクチャ概要](../architecture.md) - システム全体のアーキテクチャ

## サポート

質問や問題がある場合は、以下の方法でサポートを受けられます：

- **システム管理者に連絡**: 社内のシステム管理者に問い合わせてください
- **GitHubイシュー**: 技術的な問題はGitHubのIssueで報告してください
