@page "/mcp-chat-en"
@rendermode InteractiveServer
@using BlazorWeb.Models
@using BlazorWeb.Services
@using System.Text.Json
@inject McpChatService McpChatService
@inject ILogger<McpChatEnglish> Logger
@implements IAsyncDisposable

<PageTitle>MCP Chat - Employee Management System</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Chat" Class="mr-2" />
        MCP Chat - Integrated Service Operations
    </MudText>

    @if (!_isAnyConnected)
    {
        <!-- Connection Panel -->
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Connect to MCP Servers</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Class="mb-3">
                    Connect to each service of the Employee Management System via MCP.
                    After connection, you can execute operations using structured JSON arguments.
                </MudText>

                <MudGrid>
                    @foreach (var server in McpChatService.AvailableServers)
                    {
                        <MudItem xs="12" sm="6" md="3">
                            <MudCard Outlined="true">
                                <MudCardContent Class="text-center">
                                    <MudIcon Icon="@server.Icon" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                                    <MudText Typo="Typo.h6">@GetEnglishName(server.Name)</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                        @GetEnglishDescription(server.Name)
                                    </MudText>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    }
                </MudGrid>

                <MudButton 
                    Variant="Variant.Filled" 
                    Color="Color.Primary" 
                    FullWidth="true"
                    Class="mt-4"
                    OnClick="ConnectToAllServersAsync" 
                    Disabled="@_isConnecting"
                    StartIcon="@Icons.Material.Filled.Link">
                    @if (_isConnecting)
                    {
                        <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                        <span>Connecting...</span>
                    }
                    else
                    {
                        <span>Connect to All Services</span>
                    }
                </MudButton>

                @if (_connectionErrors.Any())
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-3">
                        <MudText Typo="Typo.body2">Failed to connect to some servers:</MudText>
                        <MudList T="string" Dense="true">
                            @foreach (var error in _connectionErrors)
                            {
                                <MudListItem T="string">@error</MudListItem>
                            }
                        </MudList>
                    </MudAlert>
                }
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <!-- Connected State UI -->
        <MudGrid>
            <!-- Left Panel: Server List and Tools -->
            <MudItem xs="12" md="4">
                <!-- Connection Status -->
                <MudCard Class="mb-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Connection Status</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton 
                                Icon="@Icons.Material.Filled.Refresh" 
                                Color="Color.Primary" 
                                OnClick="RefreshAllToolsAsync"
                                Size="Size.Small" />
                            <MudIconButton 
                                Icon="@Icons.Material.Filled.LinkOff" 
                                Color="Color.Error" 
                                OnClick="DisconnectAll"
                                Size="Size.Small" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudList T="string" Dense="true">
                            @foreach (var serverName in McpChatService.ConnectedServers)
                            {
                                var server = McpChatService.AvailableServers.FirstOrDefault(s => s.Name == serverName);
                                if (server != null)
                                {
                                    <MudListItem T="string"
                                        Icon="@server.Icon" 
                                        IconColor="Color.Success"
                                        OnClick="@(() => SelectServer(serverName))">
                                        <MudText Typo="Typo.body1">@GetEnglishName(server.Name)</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            @(McpChatService.GetToolsForServer(serverName)?.Count ?? 0) tools
                                        </MudText>
                                    </MudListItem>
                                }
                            }
                        </MudList>
                    </MudCardContent>
                </MudCard>

                <!-- Available Tools -->
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">
                                Available Tools
                                @if (!string.IsNullOrEmpty(_selectedServerName))
                                {
                                    var server = McpChatService.AvailableServers.FirstOrDefault(s => s.Name == _selectedServerName);
                                    @if (server != null)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@GetEnglishName(server.Name)</MudChip>
                                    }
                                }
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Style="max-height: 500px; overflow-y: auto;">
                        @if (!string.IsNullOrEmpty(_selectedServerName))
                        {
                            var tools = McpChatService.GetToolsForServer(_selectedServerName);
                            if (tools != null && tools.Any())
                            {
                                <MudList T="string" Dense="true">
                                    @foreach (var tool in tools)
                                    {
                                        <MudListItem T="string" OnClick="@(() => SelectTool(tool))">
                                            <MudText Typo="Typo.body1">
                                                <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Class="mr-1" />
                                                @tool.Name
                                            </MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @tool.Description
                                            </MudText>
                                        </MudListItem>
                                    }
                                </MudList>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No tools available</MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Select a server from the left to display tools
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Right Panel: Chat Area -->
            <MudItem xs="12" md="8">
                <!-- Chat History -->
                <MudCard Class="mb-4" Style="height: 500px; display: flex; flex-direction: column;">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Chat History</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton 
                                Icon="@Icons.Material.Filled.Delete" 
                                Color="Color.Error" 
                                OnClick="ClearChatHistory"
                                Size="Size.Small" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent Style="flex: 1; overflow-y: auto;" id="chat-container">
                        @if (!_chatHistory.Any())
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="mt-4">
                                Select and execute a tool to start
                            </MudText>
                        }
                        else
                        {
                            @foreach (var message in _chatHistory)
                            {
                                <div class="@(message.IsUser ? "d-flex justify-end mb-3" : "d-flex justify-start mb-3")">
                                    <MudPaper 
                                        Class="pa-3" 
                                        Style="@(message.IsUser ? "background-color: #1976d2; color: white; max-width: 70%;" : "background-color: #f5f5f5; max-width: 70%;")">
                                        <MudText Typo="Typo.body2" Style="@(message.IsUser ? "color: white;" : "")">
                                            <strong>@(message.IsUser ? "You" : "MCP")</strong>
                                        </MudText>
                                        <MudText Typo="Typo.body1" Style="@(message.IsUser ? "color: white; white-space: pre-wrap;" : "white-space: pre-wrap;")">
                                            @message.Text
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="@(message.IsUser ? "color: rgba(255,255,255,0.7);" : "color: rgba(0,0,0,0.6);")">
                                            @message.Timestamp.ToString("HH:mm:ss")
                                        </MudText>
                                    </MudPaper>
                                </div>
                            }
                        }
                    </MudCardContent>
                </MudCard>

                <!-- Tool Execution Panel -->
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Tool Execution</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (_selectedTool != null && !string.IsNullOrEmpty(_selectedServerName))
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                <strong>@_selectedTool.Name</strong>: @_selectedTool.Description
                            </MudAlert>

                            <MudTextField 
                                @bind-Value="_toolArguments" 
                                Label="Arguments (JSON format)" 
                                Variant="Variant.Outlined"
                                Lines="5"
                                Placeholder='{"employeeId": "guid-here"}' 
                                Class="mb-3" />

                            <MudButton 
                                Variant="Variant.Filled" 
                                Color="Color.Success" 
                                OnClick="ExecuteToolAsync"
                                Disabled="@_isExecuting"
                                StartIcon="@Icons.Material.Filled.PlayArrow"
                                FullWidth="true">
                                @if (_isExecuting)
                                {
                                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                                    <span>Executing...</span>
                                }
                                else
                                {
                                    <span>Execute Tool</span>
                                }
                            </MudButton>

                            @if (!string.IsNullOrEmpty(_executionError))
                            {
                                <MudAlert Severity="Severity.Error" Class="mt-3">@_executionError</MudAlert>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                                Select a tool from the left panel
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Help Section -->
        <MudExpansionPanels Class="mt-4">
            <MudExpansionPanel Text="Usage Guide" Icon="@Icons.Material.Filled.Help">
                <MudText Typo="Typo.h6" Class="mb-2">How to Use MCP Chat</MudText>
                <MudList T="string">
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                        <strong>1. Select Server:</strong> Choose a service from the connection status list
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                        <strong>2. Select Tool:</strong> Pick an operation from the available tools
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                        <strong>3. Enter Arguments:</strong> Provide required parameters in JSON format
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                        <strong>4. Execute:</strong> Click "Execute Tool" to run the operation
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                        <strong>5. View Results:</strong> Results appear in the chat history
                    </MudListItem>
                </MudList>
                
                <MudText Typo="Typo.h6" Class="mt-4 mb-2">JSON Argument Examples</MudText>
                <MudPaper Class="pa-3 mb-2" Outlined="true">
                    <MudText Typo="Typo.body2">Get Employee:</MudText>
                    <code>{"employeeId": "your-guid-here"}</code>
                </MudPaper>
                <MudPaper Class="pa-3" Outlined="true">
                    <MudText Typo="Typo.body2">Create Employee:</MudText>
                    <code>{"firstName": "John", "lastName": "Doe", "email": "john@example.com", "departmentId": "dept-guid", "position": "Engineer", "hireDate": "2024-01-01"}</code>
                </MudPaper>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
</MudContainer>

@code {
    private bool _isConnecting;
    private bool _isExecuting;
    private bool _isAnyConnected;
    private List<string> _connectionErrors = new();
    private List<ChatMessage> _chatHistory = new();
    private string? _selectedServerName;
    private ModelContextProtocol.Client.McpClientTool? _selectedTool;
    private string _toolArguments = string.Empty;
    private string? _executionError;

    private string GetEnglishName(string serverName) => serverName switch
    {
        "EmployeeService" => "Employee Service",
        "AuthService" => "Authentication Service",
        "NotificationService" => "Notification Service",
        "AttendanceService" => "Attendance Service",
        _ => serverName
    };

    private string GetEnglishDescription(string serverName) => serverName switch
    {
        "EmployeeService" => "Manage employees and departments",
        "AuthService" => "User and role management",
        "NotificationService" => "System notifications",
        "AttendanceService" => "Attendance records and leave requests",
        _ => ""
    };

    private async Task ConnectToAllServersAsync()
    {
        _isConnecting = true;
        _connectionErrors.Clear();
        StateHasChanged();

        try
        {
            var results = await McpChatService.ConnectToAllServersAsync();
            
            foreach (var (serverName, success) in results)
            {
                if (!success)
                {
                    var server = McpChatService.AvailableServers.FirstOrDefault(s => s.Name == serverName);
                    _connectionErrors.Add($"{GetEnglishName(serverName)}: Connection failed");
                }
            }

            _isAnyConnected = McpChatService.ConnectedServers.Any();
            
            if (_isAnyConnected)
            {
                AddSystemMessage($"Connected to {McpChatService.ConnectedServers.Count} server(s)");
                
                if (McpChatService.ConnectedServers.Any())
                {
                    _selectedServerName = McpChatService.ConnectedServers.First();
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to connect to servers");
            _connectionErrors.Add($"Unexpected error: {ex.Message}");
        }
        finally
        {
            _isConnecting = false;
            StateHasChanged();
        }
    }

    private void DisconnectAll()
    {
        McpChatService.DisconnectAll();
        _isAnyConnected = false;
        _selectedServerName = null;
        _selectedTool = null;
        _chatHistory.Clear();
        StateHasChanged();
    }

    private void SelectServer(string serverName)
    {
        _selectedServerName = serverName;
        _selectedTool = null;
        _toolArguments = string.Empty;
        _executionError = null;
        StateHasChanged();
    }

    private void SelectTool(ModelContextProtocol.Client.McpClientTool tool)
    {
        _selectedTool = tool;
        _toolArguments = "{}";
        _executionError = null;
        StateHasChanged();
    }

    private async Task ExecuteToolAsync()
    {
        if (_selectedTool == null || string.IsNullOrEmpty(_selectedServerName))
            return;

        _isExecuting = true;
        _executionError = null;
        StateHasChanged();

        try
        {
            var arguments = new Dictionary<string, object?>();
            if (!string.IsNullOrWhiteSpace(_toolArguments))
            {
                var jsonDoc = JsonDocument.Parse(_toolArguments);
                foreach (var prop in jsonDoc.RootElement.EnumerateObject())
                {
                    arguments[prop.Name] = prop.Value.ValueKind switch
                    {
                        JsonValueKind.Number => prop.Value.GetDouble(),
                        JsonValueKind.String => prop.Value.GetString(),
                        JsonValueKind.True => true,
                        JsonValueKind.False => false,
                        JsonValueKind.Null => null,
                        _ => prop.Value.ToString()
                    };
                }
            }

            var serverDisplayName = GetEnglishName(_selectedServerName);
            AddUserMessage($"[{serverDisplayName}] {_selectedTool.Name}\nArguments: {JsonSerializer.Serialize(arguments, new JsonSerializerOptions { WriteIndented = true })}");

            var result = await McpChatService.CallToolAsync(_selectedServerName, _selectedTool.Name, arguments);

            var responseText = FormatToolResult(result);
            AddSystemMessage(responseText);

            _toolArguments = "{}";
        }
        catch (JsonException ex)
        {
            _executionError = $"Invalid JSON format: {ex.Message}";
            Logger.LogError(ex, "Invalid JSON in tool arguments");
        }
        catch (Exception ex)
        {
            _executionError = $"Execution error: {ex.Message}";
            Logger.LogError(ex, "Tool execution failed");
            AddSystemMessage($"❌ Error: {ex.Message}");
        }
        finally
        {
            _isExecuting = false;
            StateHasChanged();
        }
    }

    private async Task RefreshAllToolsAsync()
    {
        try
        {
            foreach (var serverName in McpChatService.ConnectedServers)
            {
                await McpChatService.RefreshToolsAsync(serverName);
            }
            AddSystemMessage("Tool list refreshed");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to refresh tools");
        }
    }

    private void ClearChatHistory()
    {
        _chatHistory.Clear();
        StateHasChanged();
    }

    private void AddUserMessage(string text)
    {
        _chatHistory.Add(new ChatMessage
        {
            Text = text,
            IsUser = true,
            Timestamp = DateTime.Now
        });
        StateHasChanged();
    }

    private void AddSystemMessage(string text)
    {
        _chatHistory.Add(new ChatMessage
        {
            Text = text,
            IsUser = false,
            Timestamp = DateTime.Now
        });
        StateHasChanged();
    }

    private string FormatToolResult(ModelContextProtocol.Protocol.CallToolResult result)
    {
        if (result.Content.Count == 0)
            return "✅ Execution completed (no response)";

        var responseText = "✅ Execution result:\n\n";
        foreach (var content in result.Content)
        {
            if (content is ModelContextProtocol.Protocol.TextContentBlock textBlock)
            {
                responseText += textBlock.Text + "\n";
            }
            else
            {
                responseText += content.ToString() + "\n";
            }
        }

        try
        {
            var firstText = result.Content.FirstOrDefault() as ModelContextProtocol.Protocol.TextContentBlock;
            if (firstText != null)
            {
                var jsonDoc = JsonDocument.Parse(firstText.Text);
                responseText = "✅ Execution result:\n\n" + JsonSerializer.Serialize(jsonDoc, new JsonSerializerOptions { WriteIndented = true });
            }
        }
        catch
        {
            // If JSON formatting fails, keep original
        }

        return responseText;
    }

    public async ValueTask DisposeAsync()
    {
        if (McpChatService != null)
        {
            await McpChatService.DisposeAsync();
        }
    }

    private class ChatMessage
    {
        public string Text { get; set; } = string.Empty;
        public bool IsUser { get; set; }
        public DateTime Timestamp { get; set; }
    }
}
