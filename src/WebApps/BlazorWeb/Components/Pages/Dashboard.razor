@page "/dashboard"
@inject IHttpClientFactory HttpClientFactory
@inject BlazorWeb.Services.IEmployeeApiClient EmployeeApiClient
@using Shared.Contracts.EmployeeService

<PageTitle>ダッシュボード - 従業員管理システム</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">ダッシュボード</MudText>
<MudText Typo="Typo.body1" Class="mb-4">システムの概要と統計情報</MudText>

@if (_isLoading)
{
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="40%" Height="3rem" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="80%" />
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="40%" Height="3rem" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="80%" />
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="40%" Height="3rem" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="80%" />
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="60%" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="40%" Height="3rem" />
                    <MudSkeleton SkeletonType="SkeletonType.Text" Width="80%" />
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
    return;
}

@if (_hasError)
{
    <MudAlert Severity="Severity.Error" Class="mb-4">
        データの取得に失敗しました。@_errorMessage
    </MudAlert>
}

<MudGrid>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">総従業員数</MudText>
                <MudText Typo="Typo.h3" Color="Color.Primary">@_totalEmployees</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">登録済み従業員</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">アクティブユーザー</MudText>
                <MudText Typo="Typo.h3" Color="Color.Success">@_activeUsers</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">現在ログイン中</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">部署数</MudText>
                <MudText Typo="Typo.h3" Color="Color.Info">@_departments</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">登録部署</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.h6">今月の新規登録</MudText>
                <MudText Typo="Typo.h3" Color="Color.Warning">@_newThisMonth</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">新規追加</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12" md="8">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">最近の活動</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (_recentActivities.Any())
                {
                    <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                        @foreach (var activity in _recentActivities)
                        {
                            var color = activity.ActivityType == "Created" ? Color.Success : Color.Info;
                            var title = activity.ActivityType == "Created" ? "新規従業員登録" : "情報更新";
                            
                            <MudTimelineItem Color="@color" Elevation="2">
                                <ItemContent>
                                    <MudText Typo="Typo.body1"><strong>@title</strong></MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@activity.Description</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@GetRelativeTime(activity.Timestamp)</MudText>
                                </ItemContent>
                            </MudTimelineItem>
                        }
                    </MudTimeline>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-4">最近のアクティビティはありません</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
    
    <MudItem xs="12" md="4">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">クイックアクション</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudStack Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.PersonAdd" 
                               FullWidth="true"
                               Disabled="true">
                        新規従業員登録
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Secondary" 
                               StartIcon="@Icons.Material.Filled.Search" 
                               FullWidth="true"
                               Disabled="true">
                        従業員検索
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Tertiary" 
                               StartIcon="@Icons.Material.Filled.Assessment" 
                               FullWidth="true"
                               Disabled="true">
                        レポート生成
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Default" 
                               StartIcon="@Icons.Material.Filled.Settings" 
                               FullWidth="true"
                               Disabled="true">
                        設定
                    </MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
        
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">システムステータス</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudStack Spacing="2">
                    <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">従業員サービス: @_employeeServiceStatus</MudChip>
                    <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">認証サービス: @_authServiceStatus</MudChip>
                    <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">データベース: 正常</MudChip>
                </MudStack>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private bool _isLoading = true;
    private bool _hasError = false;
    private string _errorMessage = string.Empty;
    
    private int _totalEmployees = 0;
    private int _activeUsers = 0;
    private int _departments = 0;
    private int _newThisMonth = 0;
    private string _employeeServiceStatus = "確認中...";
    private string _authServiceStatus = "確認中...";
    private List<RecentActivityDto> _recentActivities = new();

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        _hasError = false;

        try
        {
            // ダッシュボード統計情報を取得
            var statistics = await EmployeeApiClient.GetDashboardStatisticsAsync();
            _totalEmployees = statistics.TotalEmployees;
            _departments = statistics.DepartmentCount;
            _newThisMonth = statistics.NewEmployeesThisMonth;

            // アクティブユーザー数は総従業員数をベースに表示（暫定）
            // TODO: AuthServiceと連携して実際のアクティブユーザー数を取得
            _activeUsers = _totalEmployees > 0 ? (int)(_totalEmployees * 0.3) : 0;

            // 最近のアクティビティを取得
            var activities = await EmployeeApiClient.GetRecentActivitiesAsync(5);
            _recentActivities = activities.ToList();

            // サービスステータスをチェック
            await CheckServicesStatus();
        }
        catch (Exception ex)
        {
            _hasError = true;
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task CheckServicesStatus()
    {
        try
        {
            var employeeClient = HttpClientFactory.CreateClient("employeeservice-api");
            var employeeResponse = await employeeClient.GetAsync("/health");
            _employeeServiceStatus = employeeResponse.IsSuccessStatusCode ? "正常" : "エラー";
        }
        catch
        {
            _employeeServiceStatus = "接続不可";
        }

        try
        {
            var authClient = HttpClientFactory.CreateClient("authservice-api");
            var authResponse = await authClient.GetAsync("/health");
            _authServiceStatus = authResponse.IsSuccessStatusCode ? "正常" : "エラー";
        }
        catch
        {
            _authServiceStatus = "接続不可";
        }
    }

    private string GetRelativeTime(DateTime timestamp)
    {
        var now = DateTime.UtcNow;
        var diff = now - timestamp;

        if (diff.TotalMinutes < 1)
            return "たった今";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}分前";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}時間前";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}日前";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)}週間前";
        if (diff.TotalDays < 365)
            return $"{(int)(diff.TotalDays / 30)}ヶ月前";
        return $"{(int)(diff.TotalDays / 365)}年前";
    }
}
